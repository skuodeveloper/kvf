<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>积分详情</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="plugins/layui/css/layui.css">
    <link href="plugins/datepicker/css/jquery-ui-1.10.1.css" rel="stylesheet">
    <script src="plugins/layui/layui.js" type="text/javascript"></script>
    <script src="js/vue.min.js"></script>
    <script src="plugins/datepicker/js/jquery-1.9.1.js"></script>
    <script src="plugins/datepicker/js/jquery-ui-1.10.1.min.js"></script>

    <style>
        img {
            border-radius: 50%;
            margin: 5px;
            width: 40px;
        }
    </style>
</head>
<body>

<div id="news">
    <div id="test-n1" style="margin: 1%"></div>

    <div style="margin: 10px">
        <span style="color: red;font-weight: 600">当日人数：{{jrrs}}</span><span
            style="color: red;font-weight: 600;margin-left: 20px">当日积分：{{jrjf}}</span>
        <span style="float: right;color:grey;font-size: 15px; font-weight: 600;margin-top: 1px">{{jrdate}}</span>
    </div>
    <ul class="layui-timeline" style="margin: 10px">
        <li class="layui-timeline-item" v-for="(item,index) in wxuserJf">
            <i class="layui-icon layui-timeline-axis"></i>
            <div class="layui-timeline-content layui-text">
                <div>
                    <span class="layui-timeline-title" style="font-size: 16px;font-weight: 600">{{item.zcTime|getHms}}</span>
                    <span style="float: right;font-size: 15px;font-weight: 600;color: red;margin-right: 10px">+{{item.addJf}}分</span>
                </div>
                <div style="height: 50px;line-height: 50px;">
                    <img :src=item.orginHeadimgurl>
                    <span style="font-weight: 600">{{item.orginNickname}}</span>
                </div>
            </div>
        </li>
    </ul>
</div>
<script>
    $(function () {
        var inviteCode = getUrlParameter('inviteCode');
        var realname = getUrlParameter('realname');

        //微信用户信息
        var userInfo = sessionStorage.getItem('userInfo');
        // if (userInfo == null) {
        //     $(location).prop('href', 'test.html?inviteCode=' + inviteCode + '&realname=' + realname);
        // }

        Vue.filter('getHms', function (timestamp) {
            return getTime(timestamp);
        })

        var news = new Vue({
            el: '#news',
            data: {
                jrjf: {},
                jrrs: {},
                jrdate: getNowFormatDate(),
                wxuserJf: []
            }
        });

        // $("#test-n1").datepicker('widget').wrap('<div class="ll-skin-vigo"/>');
        $("#test-n1").datepicker({
            inline: true,
            showOtherMonths: true
        })

        getWxUserJf();

        $(document).on('change', '#test-n1', function (e) {
            news.jrdate = $(this).val();
            getWxUserJf();
        })

        function getWxUserJf() {
            $.ajax({
                type: 'GET',
                url: 'http://nhmsfz.fanchance.com/func/wxUserJf/getByInvitedCode',
                data: {
                    invitedCode: inviteCode,
                    targetDate: news.jrdate
                },
                dataType: 'json',
                success: function (r) {
                    if (r.code === 200) {
                        news.wxuserJf = r.data;
                        news.jrrs = news.wxuserJf.length;

                        var jrjf = 0.0;
                        $.each(news.wxuserJf, function (i, e) {
                            jrjf += e.addJf;
                        })

                        news.jrjf = Math.formatFloat(jrjf, 1);
                    } else {
                        alert(r.msg);
                    }
                },
                error: function (error) {
                    throw new Error(error);
                }
            })
        }

        // f代表需要计算的表达式，digit代表小数位数
        Math.formatFloat = function (f, digit) {
            // Math.pow(指数，幂指数)
            var m = Math.pow(10, digit);
            // Math.round（） 四舍五入
            return Math.round(f * m, 10) / m;
        }


        function getUrlParameter(name) {
            name = name.replace(/[]/, "\[").replace(/[]/, "\[").replace(/[]/, "\\\]");
            var regexS = "[\\?&]" + name + "=([^&#]*)";
            var regex = new RegExp(regexS);
            var results = regex.exec(window.parent.location.href);
            if (results == null)
                return "";
            else {
                return results[1];
            }
        }

        function getTime(timestamp) {
            var date = new Date(timestamp);
            h = date.getHours() > 9 ? date.getHours() + ':' : '0' + date.getHours() + ':';
            m = date.getMinutes() > 9 ? date.getMinutes() + ':' : '0' + date.getMinutes() + ':';
            s = date.getSeconds() > 9 ? date.getSeconds() : '0' + date.getSeconds();

            return h + m + s;
        }

        //获取当前时间，格式YYYY-MM-DD
        function getNowFormatDate() {
            var date = new Date();
            var seperator1 = "-";
            var year = date.getFullYear();
            var month = date.getMonth() + 1;
            var strDate = date.getDate();
            if (month >= 1 && month <= 9) {
                month = "0" + month;
            }
            if (strDate >= 0 && strDate <= 9) {
                strDate = "0" + strDate;
            }
            var currentdate = year + seperator1 + month + seperator1 + strDate;
            return currentdate;
        }
    })
</script>
</body>
</html>